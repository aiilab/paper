% vim:ts=4:sw=4
% Copyright (c) 2014 Casper Ti. Vector
% Public domain.

\chapter{智能监控环境下多角度人脸特征点定位}
    第一章测试文字

\section{人脸特征点定位研究概述}
人脸有复杂的表面结构，因而人脸的描述或刻画相对简单的物体来说较为复杂；同时面部肌肉的运动使得人脸成为一种非刚体目标，与刚体目标识别相比，非刚体目标的检测和定位更加困难。此外，由于光照，姿态，饰物，遮挡以及采集和成像条件的变化，使得面部特征点的局部外观和人脸形状的变化千差万别。对于计算机而言，要分辨这些变化和其间的差别是一件十分困难的事情。
\begin{figure}[!ht] \centering
  \includegraphics[width=.8\textwidth]{figure/fig_face_variation.eps}
  \bicaption[landmark]{人脸图像的复杂变化 ~\label{fig_face_variation}}{The complex variance of face image}
\end{figure}
从图\ref{fig_face_variation}中的人脸图像示例中可以看到要让计算机自动完成这项任务，研究人员面临巨大的挑战。因而，研究者必须设计各种算法和模型，以及参照人类对这些模式的认知来指导计算机对人脸图像进行分析，从而完成特征点的定位和人脸形状的提取。

人脸特征点（Face landmark）定位是在人脸检测基础上，找到具有语义的人脸特征点，如眼角、眉端、鼻尖、嘴巴轮廓等，如下图3.1所示。
\begin{figure}[!ht] \centering
  \includegraphics[width=.6\textwidth]{figure/fig_landmark_num.eps}
  \bicaption[landmark]{人脸特征点图示 ~\label{fig_hog_face}}{Illustrations of Face Landmarks}
\end{figure}
该技术对人脸识别、建模、跟踪、动画制作等是极为关键的步骤。对于一幅人脸图像，通过定位特征点可以方便地抽取人脸的各部分特征，若以这些特征点为基准对抽取的各个特征值进行归一化，则这些特征值具有平移、旋转和尺度上的不变性，通过这样对人脸进行规范化处理，可以将不同大小、方向和水平旋转等情况的人脸统一起来，扩大人脸库的入库范围，提高人脸识别的速度。从某种意义上讲，面部关键特征点的定位，亦即人脸图像像素之间高层语义的对齐，是人脸识别最核心的问题之一。错误的特征定位会导致提取的人脸描述特征的严重变形，即使是不精确的对齐也会带来识别性能的快速下降。所以准确的人脸特征点定位对于后续的人脸识别有很大的影响。

在早期的研究方法中，进行人脸面部特征定位的方法主要有主动形状模型（Active Shape Models, ASM）\supercite{Cootes1995Active}以及主动外观模型（Active Appearance Models, AAM）\supercite{Cootes1998Active,cootes2001active_pami}。现有的主流方法大致分为两类，一种是基于参数模型的方法，另外一种是基于回归的方法。参数形状模型（Parametric Shape Model）存在着如下缺点，一是参数误差和对齐误差不一定对等，通过最小化参数化误差得到的结果是次优的。此外， 参数化模型通常很难具体估计模型的大小，通常是启发式的，或者使用固定数量的参数，因此在迭代对齐中不能灵活应变。基于参数模型的方法以Cootes在1995年提出的ASM方法为代表，ASM方法将多个脸部特征点的纹理和位置关系作为约束条件，计算出一个参数模型。从局部特征中检测到所求的关键点，但是这种方法对噪声敏感。AAM则易受初始化值和外观的变化的影响。在后续的工作中，研究者们虽然对ASM和AAM做出了改进，但是这些方法普遍存在泛化能力差、训练耗时严重等现象，对于真实场景下的人脸特征点定位很难取得很好的效果。另外一种流行的方法是基于局部部分可变模型的方法（Deformable Part Models，DPM）\supercite{Hossein2012Object}，该方法虽然在物体检测方面表现良好，但是对于准确度较高的人脸标记估计，其表现一般。

现有方法中取得比较好的效果的是P. Doll{\'a}r等人提出的级联位姿回归（Cascaded Pose Regression，CPR）\supercite{Dollar2010Cascaded}方法，这种方法在估计人脸标记当中准确率和效率都有很大提高，并成为一种主流方法，然而CPR方法仍不能很好的解决遮挡和形变过大的问题。基于此，研究者提出了一些改进的算法，如在2012年CVPR中，Cao等人受形状回归模型（Shape Regression Model, SRM）\supercite{Cao2012Face}的启发提出了Explicit Shape Regression（ESR）模型，该方法直接通过回归估计形状，克服高维输出等挑战，且保留了形状约束。在2013年的ICCV中，Burgos等人提出了鲁棒的级联位姿回归（Robust Cascaded Pose Regression, RCPR）\supercite{Burgosartizzu2013Robust}，专注于解决人脸特征点定位过程中的遮挡和大的姿态形变问题。RCPR方法与ESR方法相比，RCPR当预检测失败的时，添加了一个智能重启方法。基于这些方法，并针对监控环境下人脸姿态变化及遮挡的问题，本文研究并寻找一个对于遮挡和形变的鲁棒人脸特征点定位方法，方法要求能够精确、快速、鲁棒地估计出人脸特征点。为了跟传统的AAM方法比较，本章首先介绍在人脸特征点定位经典的AAM方法，然后再介绍基于级联回归模型的多角度人脸特征点定位方法，并从方法和实验上进行比较。
\section{基于主动外观模型的人脸特征点定位}
人脸特征点定位的目标是能够对人脸进行全自动精确定位. 主动形状模型 (Active shape modal, ASM) 和主动外观模型 (Active appearance modal, AAM) 的发表为全自动人脸特征点定位工作提供了很好的思路和解决框架. 之后很多研究工作也都在 ASM 和 AAM 的框架下进行了改进。AAM是近年来在特征点定位领域得到广泛应用的一种快速有效的方法。基于AAM的人脸特征点定位方法不但考虑了局部特征信息，而且考虑了全局的形状和纹理信息，通过对人脸的形状特征和纹理特征进行统计分析，建立对应的AAM模型，对被测人脸对象进行特征点定位时,结合“合成$\rightarrow$比较$\rightarrow$调整再合成$\rightarrow$再比较”这样一个图像拟合(image fitting)策略，往往能够实现快速而又准确的人脸特征点定位。

AAM模型是对象的动态表观模型，表观是形状和纹理的组合，表观模型是在形状模型的基础上结合对象的纹理而建立的，AAM模型实例就是将AAM的表观模型通过仿射变换的形式映射到对应的形状实例中去，得到描述当前对象的当前模型。动态就体现在AAM通过相应的拟合算法不断调整生成新的AAM模型实例与待定位的对象进行匹配，直到生成的模型实例能和该对象真正吻合，可见生成AAM模型实例是AAM中比较重要的一个部分。

AAM模型也是一种基于统计信息建模来实现对目标图像的搜索与解释的一种方法。在主动表观模型中，不仅对形状进行建模，同时又建立了反映目标物体灰度变化的纹理模型。并将纹理模型与形状模型合理地结合起来，建立起了反应整个目标图像形状及纹理共同合理变化的统计表观模型。该方法采用了基于优化算法的搜索机制，使合成的模型与目标图像不断接近，最终得到能够反应目标图像纹理及形状的合成模型。本节分别对形状建模、表观建模和模型生成中拟合计算部分三步来介绍AAM模型的建立过程。

\subsection{形状建模}
统计模型的建立需要分三个步骤，首先是获取样本图像中的信息；其次是样本图像集的归一化处理；然后是对归一化处理的数据进行统计分析，建立统计模型。因此不论AAM对形状还是对表观建模都是遵循统计模型建立的基本步骤。
AAM形状建模实现步骤如下：

（1）选择一些适合的学习样本，在训练集中的每一个训练样本上手工标定$k$个特征点(landmark)，这$k$个特征点代表了人脸上一些比较显著的特征点，那么人脸形状可由人脸的$k$个标定点组成的向量表示为:
\begin{equation}
\bm{S_i}=[x_{i0},y_{i0},x_{i1},y_{i1},\cdots,x_{ik},y_{ik}]^T
\label{equ_landmark_shape}
\end{equation}

（2）对训练集合中的每个形状向量, 进行中心、 尺度和方向的归一化。归一化是指把所有用于学习的人脸形状去除旋转、缩放和平移等全局变换，如图\ref{fig_faceshape_norm}所示。
\begin{figure}[!h] \centering
  \includegraphics[width=.7\textwidth]{figure/fig_faceshape_norm.eps}
  \bicaption[人脸形状归一化]{人脸形状归一化示例~\label{fig_faceshape_norm}}{Normalization of facial features}
\end{figure}
为了对齐所有的训练样本，一般采用 Procrustes方法\supercite{J2001Procrustes}。该方法实际上是一种几何学的方法，它把一系列的点分布模型通过适当的平移、旋转、放缩变换，在不改变点分布模型的形状的基础之上对齐到同一个点分布模型，从而改变获取的原始数据的杂乱无章的状态，减少“非形状”因素对人脸点分布模型数据分析的影响，为人脸特征提取做好准备。其基本思想是最小化所有形状到平均形状的距离和。即：
\begin{equation}
D=\sum |S_i-\bar{S}|^2
\label{equ_Procrustes}
\end{equation}
其迭代过程为：
\begin{itemize}
\item 对每个样本$x_i$做旋转、缩放并与样本$x_1$对齐，因此得到$\bar{x}$；
\item 重复计算变换后的形状平均值$\bar{x}$，将所有样本旋转、缩放、并与平均形状对齐；
\item 如果平均形状$\bar{x}$变化不大，即收敛，则算法停止；否则，算法继续重复。
\end{itemize}

（3）对归一化的形状进行主成分分析(PCA)变换，得到对应训练集的平均形状$S_0$和前$n$个特征值对应的形状特征向量$S_i$；

（4）任意人脸形状$S$就可以用线性方程进行表达：
\begin{equation}
S=S_0+\sum_{i=1}^{n}p_iS_i
\label{equ_landmark_shape_2}
\end{equation}

式中，$S_0$为平均形状，$p_i$为形状参数，$S_i$为保留的主成分特征向量所构成的变换矩阵，可通过计算协方差矩阵的特征值得到。$S_i$反映了形状的主要模式，$b$反映了任意形状在平均形状基础上的形变。这样就完成了对形状的建模。

\subsection{纹理建模}
AAM的纹理$A(x)$是训练集中已经标记好的形状区域内的对象纹理信息，它是对象形状和纹理的组合。获取表观的方法是，利用计算机图形学中纹理映射的方法，对每个表观样本通过已经标记好的形状外形来获得其纹理的有效区域，建立一个可逆的映射方程式，然后将这个表观区域映射到一个己设定的基准形状网格，在该形状网格内进行一致的参数采样，再将它们映射回各自的纹理区域，这样就可以获得归一化的纹理样本，再对归一化后的纹理进行PCA即得到了所需要的表观模型的参数，实现了纹理建模。在获得纹理向量前，需要得到纹理的标准模板。将人脸区域划分为多个三角形区域，通过三角形仿射将图像样本的纹理信息投影到标准模板。以$S_0$ 作为纹理模板的基础进行适当的调整后得到模板，采用三角分段仿射的方法将各种姿态，各种表情的人脸图片映射到标准的人脸，得到标准纹理图，如图\ref{fig_transform}所示。
\begin{figure}[!h] \centering
  \includegraphics[width=.7\textwidth]{figure/fig_transform.eps}
  \bicaption[分段仿射效果图]{分段线性仿射效果图~\label{fig_transform}}{Illustration of Piecewise Linear Affine }
\end{figure}
总结来看，对标准的建模要以下几个步骤：

（1）将$S_0$和训练集中的人脸形状，分别Delaunay三角化；

（2）通过分段线性仿射的方法将样本集人脸形状中的纹理信息映射到平均形状$S_0$中去，实现对纹理归一化；

（3）对归一化后的纹理信息进行PCA变换，得到平均纹理$A_0$和前$m$个特征值对应的纹理特征向量$A_i$；

（4）纹理与形状非常相似，任意人脸的纹理信息也可以用线性表达式表示：
\begin{equation}
A(x)=A_0(x)+\sum_{i=1}^{n}\lambda _iA_i(x)~~\forall x \in S_0
\label{equ_AAM2}
\end{equation}
按上述步骤操作即可完成对纹理的建模。
\subsection{AAM拟合计算}
AAM分为模型建立和模型实例生成这两部分内容，而AAM模型实例的生成需要如下步骤：先得到任意一组形状参数$p$后，用形状模型进行线性表示，就能够得到一个对应的形状$S$，接着得到一组纹理参数$\lambda$后，用纹理模型进行线性表示，得到一个对应纹理实例A(x)。最后将平均形状$S_0$中的纹理信息$A(x)$映射到当前的形状$S$中去，这样就生成了一个AAM的模型实例。

当模型建立后，要实现当前AAM模型实例与待定对象的拟合匹配就离不开AAM拟合计算。因此AAM拟合计算是AAM的核心部分，早期的AAM拟合算法是由T.F.Cootes等人
\supercite{Cootes1998Active,Sclaroff1998Active}提出，都属于标准梯度递减最优化算法。这些早期的AAM拟合算法的优势是它们用来进行最优化收敛的理论和思想都容易让人理解，但它们总是简单的假设在误差图像与参数的增加量上有一种固定的线性关系，而这种假设往往是不存在的，所以这样的拟合算法往往会引起拟合的失败，而且这些算法在迭代过程中计算量相当大，每次变量更新后都需要对 Hessian、梯度等等根据新变量进行重新计算，因此它们已经不能够满足快速准确地进行拟合计算的需要。2001 年卡耐基梅隆大学的Simon Baker等人\supercite{Matthews2004Active}提出了反向组合算法，它是一种有效的图像对齐算法，之后又扩展原反向组合算法，并且将它引入到AAM拟合计算中，提出反向组合的AAM拟合算法。反向组合算法由Lucas-Kanade\supercite{Baker2004Lucas}算法演化而来，利用反向组合进行AAM拟合计算，使得在AAM拟合计算过程中的 Hessian和梯度都能够提前在预处理中进行计算，并且避免了原AAM拟合计算中需要对这些值在迭代过程中重复计算的问题，从而大大减少了拟合的时间。主动表观模型AAM中主动体现在AAM拟合计算中，由形状建模知用PCA方法来描述形状控制点的运动变化，形状控制点表征了特征点的位置；再以AAM模型实例与输入图像差的平方和来定义一个能量函数：具体拟合过程如下：

定义$(x,y)^T=W(x,p)$是标准模板中像素点$x$在形状特征系数为$p$时映射到图像$I$中的坐标，从图像$I$中坐标$W(x,p)$处采得纹理值$I(W(x,p))$。当形状特征系数为$p$时，标准模板中像素点$x$在图像$I$上采得的像素值为$I(W(x,p))$。
\begin{equation}
E(X;p)=\sum_{x}[A_0(x)-I(W(x,p))]^2
\label{equ_aam_fitting}
\end{equation}
利用该能量函数来评价拟合程度；在定位拟合的过程中，根据模型的线性表达式，通过调整形状参数$p$，以及纹理参数$\lambda$的值，利用有效的拟合算法变化模型参数组，从而控制形状控制点的位置变化生成当前AAM模型实例，得到当前能量函数的值，再更新模型的参数。如此迭代反复以实现能量函数的最小化，达到模型实例与输入图像相拟合的目的，而最终得到的形状控制点的位置就描述了当前对象的特征点位置。具体的拟合过程如下图所示：
\begin{figure}[!ht] \centering
  \includegraphics[width=.7\textwidth]{figure/fig_aam_procedure.eps}
  \bicaption[landmark]{人脸拟合技术示例 ~\label{fig_aam_procedure}}{Illustrations of Face Fitting by AAM}
\end{figure}

基于AAM的人脸特征提取方法不但考虑了局部特征信息，而且考虑了全局的形状和纹理信息，在复杂的环境中，可以实现快速而准确的脸部特征点定位。基于 AAM 的人脸特征点定位方法充分利用了训练人脸样本和目标人脸的形状和纹理信息，其定位能力较强，具有很高的准确性，然而，该方法也存在一定的局限性。首先，基于 AAM 的人脸特征点定位方法是一种局部最优化的方法，因此模型的初始位置对迭代结果有一定的影响，如果初始位置不能满足局部最优的条件，会导致定位算法难以收敛，从而使得定位结果出现很大的偏差，导致定位失败。另外一个很重要的缺陷是在定位过程中，实时得到的 AAM 人脸形状会出现非法变形的情况，即出现不符合自然中人脸的形状规则。当出现非法变形时，AAM 没有考虑如何实时的解决这样的问题，仍然认为是正常的拟合并行，在不进行修正的情况下继续人脸特征点定位，最终导致人脸特征点定位的失败。这些问题，都需要得到解决。

\section{基于级联回归模型的多角度人脸特征点定位}
近年来，有不少其它新颖的人脸特征点定位方法被提出，并取得了比AAM较好的效果。其中包括基于回归的方法\supercite{Cao2012Face}和基于深度神经网络的方法\supercite{Sun2013Deep}等。在这些方法中，基于级联的姿态回归( Cascaded Pose Regression，CPR)方法\supercite{Dollar2010Cascaded}在特征点邻域的纹理特征与特征点位置的调整量之间建立回归关系，从而能够从特征点初始位置出发经过多次迭代回归和调整后收敛于特征点的正确位置。显性形状回归的人脸对齐方法使用矢量回归函数来完成人脸面部形状推断并且显式的最小化训练集数据对齐过程中产生的错误。CPR方法是将形状估计视为一个回归的问题来解决。利用训练所得的回归器就可以直接预测物体的形状。CPR方法的关键在于计算形状索引特征和训练回归器。 文献\parencite{Dollar2010Cascaded,Cao2012Face}运用了深度为5的随机蕨回归器，并且采用形状索引来刻画特征点的特征。基于级联的姿态回归方法易于实施，且检测效果也明显优于传统的基于ASM和AAM的方法。然而，所有这些方法都只考虑了正面或者接近正面的情形，并对遮挡其检测精度在人脸姿态角度大和有遮挡时明显下降。

针对上述问题，我们采用基于回归方法，并针对形变等问题做出了改进，并在准确率和速度上取得平衡，设计一种鲁棒的人脸特征点定位方法。级联回归量学习框架包含固有的形状约束条件，得到从粗到细的特征点位置确认。方法使用两级回归模型，包含了形状索引和基于相关性的两种特征选择方法。为了加快速度，通过采用像素级的形状索引特征和自适应的初始化策略。详细的方法介绍由以下小节分别介绍。

\subsection{级联回归模型}
定义一个人脸形状$\bm{S_i}=[x_{i0},y_{i0},x_{i1},y_{i1},\cdots,x_{ik},y_{ik}]^T$，其中$i$表示第$i$个样本个数，$x,y$为特征点的坐标位置，总共包含$k$个特征点。对于给定一个人脸图像，人脸对齐的目标是估计一个形状$S$使得与标定的真实形状$\hat{S}$?的误差最小，即：
\begin{equation}
\min ||S-\hat{S}||
\label{equ_esr_1}
\end{equation}
通常，公式\ref{equ_esr_1}所表示的对齐误差被用来引导训练和评估性能。在P. Doll{\'a}r等人提出的级联回归模型\supercite{Dollar2010Cascaded}方法中，用基于回归的方法取代传统的基于优化的方法。他们提出一种级联回归的模型用于形状回归，其步骤如下，首先，基于boosted regression的方法\supercite{Duffy2002Boosting}联合$T$个弱回归器 ，给定人脸图像$I$和初始形状$S^0$ ，每个回归器通过图像特征计算一个形状增益$\delta S$ ，然后更新当前的形状，即：
\begin{equation}
\label{equ_esr_2}
S^t=S^{t-1}+R^t(I,S^{t-1}), t=1,...,T
\end{equation}
给定$N$个训练样本$\left \{ (I_i,\hat{S}_i) \right \}_{i=1}^{N}$ ，逐步学习各个回归器直到训练误差不再减小，回归器$\bm{R}^t$通过公式\ref{equ_esr_3}得到：
\begin{equation}
\label{equ_esr_3}
R^t=\text{arg }\underset{R}{min}\sum_{i=1}^{N}\left \| \hat{S}_i-(S^{t-1}_i+R(I_i,S^{t-1}_i)) \right \|
\end{equation}
其中$S^{t-1}_t$是在上一阶段估计的形状。通过不断地更新和学习，最终得到人脸形状。原始级联回归模型如算法\ref{alg_cpr}所示。
\begin{algorithm}[tb]
    \caption{级联位姿回归算法}\label{alg_cpr}
    %\SetAlgoNoLine
    \textbf{输入}：图像$I$，初始位置$S^0$，回归器$R^1,R^2,\cdots,R^T$，特征计算函数$h^t(S^t,I)$\\
    \textbf{输出}：估计的形状$S^T$\\
    \For {$k\gets1$ \KwTo $T$}{
        计算特征$x^t=h^t(S^{t-1},I)$ \\
        计算形状增量$\delta S=R^t(x^t)$ \\
        更新形状估计$S^t=S^{t-1}+R^t(I,S^{t-1})$ \\
    }
    \textbf{返回}：{$S^t$}
\end{algorithm}

通过利用全面的训练数据明确最小化对齐误差来训练回归器，即所有的面部标记联合回归。回归器以一种非参数化的方式理解形状的限制：回归的形状总是训练形状的一个线性组合。而且为所有标记使用全局特征比使用局部特征更有区分性。这些性能使我们能够学习到一个对于大量训练数据拥有较强表达能力的灵活的模型。这种方法被称为“显式形状回归”。对于整个形状采用联合回归的主要挑战在于图像外形的大幅变化。算法使用了一个升级的回归器来推断形状-前期的回归器控制形状的大幅变化并且保证健壮,然后后期的回归器控制细小的形状变化并且保证准确度。这样形状约束自动的由粗到细的执行，如下图\ref{fig_esr}所示。
\begin{figure}[!ht] \centering
  \includegraphics[width=.7\textwidth]{figure/fig_esr.eps}
  \bicaption[esr]{显式形状回归示例 ~\label{fig_esr}}{Illustrations of Explicit Shape Regression}
\end{figure}








\subsection{形状索引特征}
\subsection{局部坐标系}
\subsection{自适应初始化}

\section{本章小结}