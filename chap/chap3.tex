% vim:ts=4:sw=4
% Copyright (c) 2014 Casper Ti. Vector
% Public domain.
\chapter{复杂姿态下人脸特征点定位}
\section{人脸特征点定位研究概述}
人脸特征点（Face landmark）定位是在人脸检测基础上，找到具有语义的人脸特征点，如眼角、眉端、鼻尖、嘴巴轮廓等，如图\ref{fig_landmark_num}所示。由于不同的姿态、表情、光照以及遮挡等因素的影响，准确地定位出各个关键特征点面临着很大的困难，另一方面，人脸的形状千差万别，再加上摄像机角度、图像质量、视角等变化，使得对面部区域更加细致的描述极为困难，如图\ref{fig_face_variation}所示。然而人脸特征点技术有着广泛应用，比如自动人脸识别，表情识别以及人脸动画自动合成等。然后本文主要用于对检测到的人脸进行归一化，以便提高后续人脸识别的准确率。
\begin{figure}[!ht] \centering
  \includegraphics[width=.6\textwidth]{figure/fig_landmark_num.eps}
  \bicaption[人脸特征点图示]{人脸特征点图示 ~\label{fig_landmark_num}}{Illustrations of Face Landmarks}
\end{figure}
\begin{figure}[!ht] \centering
  \includegraphics[width=.8\textwidth]{figure/fig_face_variation.eps}
  \bicaption[人脸图像的复杂变化]{人脸图像的复杂变化 ~\label{fig_face_variation}}{The complex variance of face image}
\end{figure}

简单地分析一下这个问题，不难发现这个任务其实可以拆分出三个子问题：
\begin{itemize}
\item 如何对人脸表观图像（输入）建模；
\item 如何对人脸形状（输出）建模；
\item 如何建立人脸表观图像（模型）与人脸形状（模型）的关联；
\end{itemize}

以往的研究工作也离不开这三个方面。人脸形状建模典型的方法有可变形模板（Deformable Template）、点分布模型、图模型等。人脸表观建模又可分为全局表观建模和局部表观建模。全局表观建模简单的说就是考虑如何建模整张人脸的表观信息，局部表观建模则是对局部区域的表观信息建模，包括颜色模型、投影模型、侧剖线模型等。
%从图\ref{fig_face_variation}中的人脸图像示例中可以看到要让计算机自动完成这项任务，研究人员面临巨大的挑战。因而，研究者必须设计各种算法和模型，并参照人类对这些模式的认知来指导计算机对人脸图像进行分析，从而完成特征点的定位和人脸形状的提取。
%人脸特征点对人脸识别、建模、跟踪、动画制作等是极为关键的步骤。对于一幅人脸图像，通过定位特征点可以方便地抽取人脸的各部分特征，若以这些特征点为基准对抽取的各个特征值进行归一化，则这些特征值具有平移、旋转和尺度上的不变性，通过这样对人脸进行规范化处理，可以将不同大小、方向和水平旋转等情况的人脸统一起来，扩大人脸库的入库范围，提高人脸识别的速度。从某种意义上讲，面部关键特征点的定位，亦即人脸图像像素之间高层语义的对齐，是人脸识别最核心的问题之一。错误的特征定位会导致提取的人脸描述特征的严重变形，不精确的对齐也会带来识别性能的快速下降，所以准确的人脸特征点定位对于后续的人脸识别有很大的影响。

在早期的研究方法中，进行人脸面部特征定位的方法主要有主动形状模型（Active Shape Models, ASM）\supercite{Cootes1995Active}以及主动外观模型（Active Appearance Models,~AAM）\supercite{Cootes1998Active,cootes2001active_pami}，即为全局表观建模。现有的主流方法大致分为两类，一种是基于参数模型的方法，另外一种是基于回归的方法。参数形状模型（Parametric Shape Model）存在着如下缺点，一是参数误差和对齐误差不一定对等，通过最小化参数化误差得到的结果是次优的。此外， 参数化模型通常很难具体估计模型的大小，通常是启发式的，或者使用固定数量的参数，因此在迭代对齐中不能灵活应变。基于参数模型的方法以Cootes在1995年提出的ASM方法为代表，ASM方法将多个脸部特征点的纹理和位置关系作为约束条件，计算出一个参数模型。从局部特征中检测到所求的关键点，但是这种方法对噪声敏感。AAM则易受初始化值和外观变化的影响。在后续的工作中，研究者们虽然对ASM和AAM做出了改进，但是这些方法普遍存在泛化能力差、训练耗时严重等现象，对于真实场景下的人脸特征点定位很难取得很好的效果。另外一种流行的方法是基于局部部分可变模型的方法（Deformable Part Models，DPM）\supercite{Hossein2012Object}，该方法虽然在物体检测方面表现良好，但是对于准确度较高的人脸标记估计，其表现一般。

近来，级联形状回归模型在特征点定位任务上取得了重大突破，该方法使用回归模型，直接学习从人脸表观到人脸形状（或者人脸形状模型的参数）的映射函数，进而建立从表观到形状的对应关系。此类方法不需要复杂的人脸形状和表观建模，简单高效，在可控场景（实验室条件下采集的人脸）和非可控场景（网络人脸图像等）均取得不错的定位效果。此外，基于深度学习的面部特征点定位方法也取得令人瞩目的结果。深度学习结合形状回归框架可以进一步提升定位模型的精度，成为当前特征定位的主流方法之一。

现有方法中取得比较好的效果的是P. Doll{\'a}r等人提出的级联姿态回归（Cascaded Pose Regression,~CPR）\supercite{Dollar2010Cascaded}方法，这种方法在估计人脸标记当中准确率和效率都有很大提高，并成为一种主流方法，然而CPR方法仍不能很好的解决遮挡和形变过大的问题。基于此，研究者提出了一些改进的算法，如在2012年CVPR中，Cao等人受形状回归模型（Shape Regression Model,~SRM）\supercite{Cao2012Face}的启发提出了Explicit Shape Regression（ESR）模型，该方法直接通过回归估计形状，克服高维输出等挑战，且保留了形状约束。在2013年的ICCV中，Burgos等人提出了鲁棒的级联位姿回归（Robust Cascaded Pose Regression,~RCPR）\supercite{Burgosartizzu2013Robust}，专注于解决人脸特征点定位过程中的遮挡和大的姿态形变问题。RCPR方法与ESR方法相比，RCPR当预检测失败的时，添加了一个智能重启方法。基于这些方法，并针对监控环境下人脸姿态变化及遮挡的问题，本文研究并寻找一个对于遮挡和形变的鲁棒人脸特征点定位方法，方法要求能够精确、快速、鲁棒地估计出人脸特征点。为了跟传统的AAM方法比较，本章首先介绍在人脸特征点定位经典的AAM方法，然后再介绍基于级联回归模型的多角度人脸特征点定位方法，并从方法和实验上进行比较。
\section{基于主动外观模型的人脸特征点定位}
1995 年由 Cootes 等人提出的主动形状模型(Active Shape Model,~ASM )是 AAM(Active appearance modal,~AAM)的直接前身，ASM和AAM是全自动人脸特征点定位的一种框架。之后很多研究工作也都在 ASM 和 AAM 的框架下进行了改进。ASM 算法利用参数化的采样形状来构成对象形状模型，并利用 PCA(Principal Component Analysis)方法建立描述形状特征点的运动模型，再利用一组参数来控制形状特征点的位置变化，从
而获得当前对象的形状。但该算法只单纯利用了对象的形状，因此准确率不高。1998 年，Cootes 等人在 ASM 算法的基础上首次提出 AAM的概念。类似于 ASM，AAM 也是在对训练数据进行统计分析的基础上，首先建立人脸模型，然后利用先验模型对图像中的目标物体进行匹配运算。与 ASM 的不同之处是它不仅利用形状信息，而且对重要的脸部纹理信息也进行统计分析，并试图找出形状与纹理之间的联系。图
\ref{fig_aam_framework_2}表示了AAM特征点定位的基本框架。
\begin{figure}[!h] \centering
  \includegraphics[width=.8\textwidth]{figure/fig_aam_framework_2.eps}
  \bicaption[AAM特征点定位框架]{AAM 特征点定位框架~\label{fig_aam_framework_2}}{AAM framework}
\end{figure}

%AAM模型是对象的动态表观模型，表观是形状和纹理的组合，表观模型是在形状模型的基础上结合对象的纹理而建立的，AAM模型实例就是将AAM的表观模型通过仿射变换的形式映射到对应的形状实例中去，得到描述当前对象的当前模型。动态就体现在AAM通过相应的拟合算法不断调整生成新的AAM模型实例与待定位的对象进行匹配，直到生成的模型实例能和该对象真正吻合，可见生成AAM模型实例是AAM中比较重要的一个部分。
%
%AAM模型也是一种基于统计信息建模来实现对目标图像的搜索与解释的一种方法。在主动表观模型中，不仅对形状进行建模，同时又建立了反映目标物体灰度变化的纹理模型。并将纹理模型与形状模型合理地结合起来，建立起了反应整个目标图像形状及纹理共同合理变化的统计表观模型。该方法采用了基于优化算法的搜索机制，使合成的模型与目标图像不断接近，最终得到能够反应目标图像纹理及形状的合成模型。本节通过形状建模、表观建模和模型生成中拟合计算三个部分来介绍AAM模型的建立过程。
基于 AAM 的人脸特征定位是一种经典的定位方法，所谓表观模型，就是在 AAM 形状模型的基础上结合所提取人脸对象的纹理信息建立起来的人脸模型。“主动”一词则形象具体地体现在 AAM 匹配计算中。首先，采用主成分分析 (Principal Component Analysis,~PCA)方法来描述形状特征点的动态变化，形状特征点表明了人脸特征的位置；其次，以具体 AAM模型实例与输入图像的均方差来定义一个能量函数，利用该能量函数来评价 AAM的匹配程度，在人脸定位匹配的过程中，根据模型的线性表达式通过有效的匹配算法变化模型参数组，从而控制形状特征点的位置变化来生成当前新的 AAM 模型实例；再次，利用当前得到的能量函数值来更新模型的参数，如此反复迭代以实现能量函数的最小化，从而达到模型实例与输入图像相匹配的目的，最终得到的形状特征点位置就描述了当前人脸图像的特征点位置。AAM 的匹配算法从最初的基于梯度下降算法的匹配计算，发展到基于线性假定的 AAM 匹配计算，再到现在的基于 Lucas-Kanade 算法的反向组合 AAM 匹配算法，都在匹配精度和效率上有了很大提高。AAM 建模是指建立对象的动态表观模型，而 AAM 模型实例指将 AAM 的表观模型通过仿射变换映射到对应的形状实例中，从而得到描述当前对象的当前模型。AAM 建模在 AAM 中起着至关重要的基础作用，本节分别从形状建模、纹理建模和模型生成中拟合计算三个部分来介绍 AAM 的建模过程 。
\subsection{形状建模}
AAM包含了形状建模和纹理建模，简单来讲，AAM形状建模实现步骤如下：

（1）选择一些适合的学习样本，在训练集中的每一个训练样本上手工标定$k$个特征点(landmark)，这$k$个特征点代表了人脸上一些比较显著的特征点，那么人脸形状可由人脸的$k$个标定点组成的向量表示为：
\begin{equation}
\bm{S_i}=[x_{i0},y_{i0},x_{i1},y_{i1},\cdots,x_{ik},y_{ik}]^T
\label{equ_landmark_shape}
\end{equation}

（2）得到训练集的的形状向量之后，进行中心、 尺度和方向的归一化。归一化的目的是为了消除由于人脸旋转、缩放、平移等变化带来的影响。如图\ref{fig_faceshape_norm}所示。
\begin{figure}[!h] \centering
  \includegraphics[width=.7\textwidth]{figure/fig_faceshape_norm.eps}
  \bicaption[人脸形状归一化示例]{人脸形状归一化示例~\label{fig_faceshape_norm}}{Normalization of facial features}
\end{figure}

一般来讲，对样本的归一化或对齐操作通常采用 Procrustes方法\supercite{J2001Procrustes}。Procrustes方法基于几何学，其基本的思想是将特征点对齐到同一个点分布模型，而不改变点分布模型的形状。对齐操作可有效解决不同人脸大小及放射变换带来的影响，以便更好地提取人脸特征。简单来讲，其目标为最小化所有形状到平均形状的距离和，即：
\begin{equation}
D=\sum |S_i-\bar{S}|^2
\label{equ_Procrustes}
\end{equation}
其迭代过程为：
\begin{itemize}
\item 对样本$x_i$做旋转、缩放等放射变换操作并与样本$x_1$对齐，得到$\bar{x}$；
\item 重新计算$\bar{x}$，并重复将所有样本进行放射变换与平均形状对齐；
\item 若$\bar{x}$变化不大，即收敛，则算法停止。否则，算法继续重复。
\end{itemize}

（3）在归一化之后，进行主成分分析(PCA)，得到对应训练集的平均形状$S_0$和前$n$个特征值对应的形状特征向量$S_i$；

（4）对于每一个人脸的形状$S$则可通过线性方程进行一一表达：
\begin{equation}
S=S_0+\sum_{i=1}^{n}p_iS_i
\label{equ_landmark_shape_2}
\end{equation}
在公式(\ref{equ_landmark_shape_2})中，$S_0$为平均形状，$p_i$为形状参数，反映了任意形状在平均形状基础上的形变。$S_i$为保留的主成分特征向量所构成的变换矩阵，可通过计算协方差矩阵的特征值得到。$S_i$反映了形状的主要模式。这样就完成了对形状的建模。

\subsection{纹理建模}
ASM将人脸图像变形到平均形状而得到形状无关图像，而AAM将形状和纹理两个统计模型进一步融合为表观模型。同ASM类似，在给定训练集上需要对所有的纹理进行主成分分析，并得到平均纹理。而表观模型将定义的形状和纹理模型结合起来，串联得到新的表观特征向量。详细的纹理建模过程在相关文献中都有详细的说明，但是需要值得注意的是，在获得纹理向量之前，需要得到纹理的标准模板，一般通过三角形仿射将图像样本的纹理信息投影到标准模板，如图\ref{fig_transform}所示。
%AAM的纹理是训练集中已经标记好的形状区域内的对象纹理信息，它是对象形状和纹理的组合。获取表观的方法是，利用计算机图形学中纹理映射的方法，对每个表观样本通过已经标记好的形状来获得其纹理的有效区域，建立一个可逆的映射方程式，然后将这个表观区域映射到一个己设定的基准形状网格，在该形状网格内进行一致的参数采样，再将它们映射回各自的纹理区域，这样就可以获得归一化的纹理样本，再对归一化后的纹理进行PCA即得到了所需要的表观模型的参数，实现了纹理建模。在获得纹理向量前，需要得到纹理的标准模板。将人脸区域划分为多个三角形区域，通过三角形仿射将图像样本的纹理信息投影到标准模板。以$S_0$ 作为纹理模板的基础进行适当的调整后得到模板，采用三角分段仿射的方法将各种姿态，各种表情的人脸图片映射到标准的人脸，得到标准纹理图，
\begin{figure}[!h] \centering
  \includegraphics[width=.7\textwidth]{figure/fig_transform.eps}
  \bicaption[分段线性仿射效果图]{分段线性仿射效果图~\label{fig_transform}}{Illustration of piecewise linear affine }
\end{figure}
总结来看，对标准的建模要以下几个步骤：

（1）将纹理模板$S_0$和训练集中的人脸形状，分别Delaunay三角化；

（2）将样本集中的人脸形状利用分段线性仿射方法将纹理信息映射到平均形状$S_0$，实现对纹理归一化；

（3）对归一化后的纹理信息进行PCA变换，得到平均纹理$A_0$和前$m$个特征值对应的纹理特征向量$A_i$；

（4）与形状建模类似，其任意人脸的纹理信息也可用线性方式进行表达：
\begin{equation}
A(x)=A_0(x)+\sum_{i=1}^{n}\lambda _iA_i(x)~~\forall x \in S_0
\label{equ_AAM2}
\end{equation}
按上述步骤操作即可完成对纹理的建模。
\subsection{AAM拟合计算}
AAM模型主要包含模型的建立及拟合计算两部分，一般来讲，其拟合步骤如下：首先，根据形状建模和纹理建模后的结果会得到形状参数$p$和纹理参数$\lambda$。然后分别用形状模型和纹理模型进行线性表示，用$A(x)$来表示对应的纹理表达，最终将$S_0$的纹理信息$A(x)$映射形状表达$S$中，从而得到表观模型的实例。

当得到表观模型后，对新的匹配对象进行人脸特征点定位其实就是一个拟合的过程。T.~F.~Cootes等人\supercite{Cootes1998Active,Sclaroff1998Active}提出的标准梯度递减最优化算法是拟合计算的经典方法。然而该方法迭代的过程非常耗时，因为在每一次迭代时都需要对Hessian、梯度等根据新变量进行重新计算。而快速准确的进行拟合计算是人脸特征点定位首要考虑的问题。Simon Baker等人\supercite{Matthews2004Active}提出了反向组合算法并将其应用到AAM的拟合计算中，该算法其实是由Lucas-Kanade\supercite{Baker2004Lucas}算法演化而来，其好处在于将Hessian 和梯度计算都放入到预处理中，从而避免了迭代过程当中重复计算的问题，使得拟合过程能够快速收敛。

定义$(x,y)^T=W(x,p)$是标准模板中像素点$x$在形状特征系数为$p$时映射到图像$I$中的坐标，从图像$I$中坐标$W(x,p)$处采得纹理值$I(W(x,p))$。当形状特征系数为$p$时，标准模板中像素点$x$在图像$I$上采得的像素值为$I(W(x,p))$。
\begin{equation}
E(X;p)=\sum_{x}[A_0(x)-I(W(x,p))]^2
\label{equ_aam_fitting}
\end{equation}
公式(\ref{equ_aam_fitting})定义为能量函数。在拟合计算的过程中，通过调整形状参数$p$，以及纹理参数$\lambda$的值，从而控制形状控制点的位置变化生成当前AAM模型实例，最终得到当前能量函数的值，然后再更新模型的参数。上述过程是一个迭代优化的过程，其优化目标是实现能量函数的最小化，即模型实例与输入图像相拟合误差最小，而通过最终收敛得到的形状参数便可获得人脸特征点的位置。其具体的拟合过程如下图所示：
\begin{figure}[!ht] \centering
  \includegraphics[width=.7\textwidth]{figure/fig_aam_procedure.eps}
  \bicaption[人脸拟合技术示例]{人脸拟合技术示例 ~\label{fig_aam_procedure}}{Illustrations of face fitting by AAM}
\end{figure}

基于主动外观模型的人脸特征点定位方法是一种经典的定位框架，该方法充分利用了训练集人脸样本和待测人脸图像的形状和纹理信息，在正面人脸特征点定位中可以取得不错的效果，许多研究者在此基础上也做了进一步改进。然而，该方法也存在一定的局限性，首先，它是一种局部最优化的方法，其对模型初始位置很敏感，如果初始位置不能满足局部最优的条件，会导致定位算法难以收敛，从而使得定位结果出现很大的偏差，导致定位失败。其次，AAM在定位过程中，将人脸形状与纹理混合起来建模，表观模型从另外一个方面来讲也给AAM的搜索过程带来了干扰，对人脸形状施加了过强的约束，并且在处理形变、选中、遮挡等问题时显得不足，如何解决上述问题是一个鲁棒的人脸特征点定位系统需要考虑的问题。
\section{基于级联回归模型的多角度人脸特征点定位}
近年来，有不少其它新颖的人脸特征点定位方法被提出，并取得了比AAM更好的效果。其中包括基于回归的方法\supercite{Cao2012Face}和基于深度神经网络的方法\supercite{Sun2013Deep}等。在这些方法中，基于级联的姿态回归( Cascaded Pose Regression,~CPR)方法\supercite{Dollar2010Cascaded}在特征点邻域的纹理特征与特征点位置的调整量之间建立回归关系，从而能够从特征点初始位置出发经过多次迭代回归和调整后收敛于特征点的正确位置。显性形状回归的人脸对齐方法使用矢量回归函数来完成人脸面部形状推断并且显式的最小化训练集数据对齐过程中产生的错误。CPR方法是将形状估计视为一个回归的问题来解决。利用训练所得的回归器就可以直接预测物体的形状。CPR方法的关键在于计算形状索引特征和训练回归器。 文献\parencite{Dollar2010Cascaded,Cao2012Face}运用了深度为5的随机蕨回归器，并且采用形状索引来刻画特征点的特征。基于级联的姿态回归方法易于实施，且检测效果也明显优于传统的基于ASM和AAM的方法。然而，所有这些方法都只考虑了正面或者接近正面的情形，并对遮挡其检测精度在人脸姿态角度大和有遮挡时明显下降。

针对上述问题，我们采用基于回归方法，并针对形变等问题做出了改进，并在准确率和速度上取得平衡，设计一种鲁棒的人脸特征点定位方法。级联回归量学习框架包含固有的形状约束条件，得到从粗到细的特征点位置确认。方法使用两级回归模型，包含了形状索引和基于相关性的两种特征选择方法。为了加快速度，通过采用像素级的形状索引特征和自适应的初始化策略。方法详情由以下小节分别介绍。

\subsection{级联回归模型}
在人脸检测算法中，最具有开创性的工作是2001年由Viola和Jones\supercite{viola2001rapid}提出来的检测框架。他们为实用的人脸检测器确定了两个基本的准则：1、使用级联结构，在早期就拒绝掉一些简单的负样本。2、使用简单的特征，加快分类速度。现在几乎所有能达到实时的人脸检测器都遵循着这两个准则。受这个框架启发，本文采用了一种级联的回归模型和可快速计算的特征进行人脸的特征点定位。下面首先分析人脸特征点的级联回归模型。

定义一个人脸形状$S_i=[x_{i0},y_{i0},x_{i1},y_{i1},\cdots,x_{ik},y_{ik}]^T$，其中$i$表示第$i$个样本，$x,y$为特征点的坐标位置，总共包含$k$个特征点。对于给定一个人脸图像，人脸对齐的目标是估计一个形状$S$使得与标定的真实形状$\hat{S}$的误差最小，即：
\begin{equation}
\min ||S-\hat{S}||
\label{equ_esr_1}
\end{equation}

通常，公式\ref{equ_esr_1}所表示的对齐误差被用来引导训练和评估性能。在P. Doll{\'a}r等人提出的级联姿态回归模型（Cascaded Pose Regression, CPR）方法\supercite{Dollar2010Cascaded}中，用基于回归的方法取代传统的基于优化的方法。他们提出一种级联回归的模型用于形状回归，其步骤如下：首先，基于boosted regression\supercite{Duffy2002Boosting}的方法联合$T$个弱回归器 ，给定人脸图像$I$和初始形状$S^0$ ，每个回归器通过图像特征计算一个形状增益$\delta S$ ，然后更新当前的形状，即：
\begin{equation}
\label{equ_esr_2}
S^t=S^{t-1}+R^t(I,S^{t-1}), t=1,...,T
\end{equation}
给定$N$个训练样本$\left \{ (I_i,\hat{S}_i) \right \}_{i=1}^{N}$ ，逐步学习各个回归器直到训练误差不再减小，回归器$\bm{R}^t$通过公式\ref{equ_esr_3}得到：
\begin{equation}
\label{equ_esr_3}
R^t=\text{arg }\underset{R}{min}\sum_{i=1}^{N}\left \| \hat{S}_i-(S^{t-1}_i+R(I_i,S^{t-1}_i)) \right \|
\end{equation}
其中$S^{t-1}_t$是在上一阶段估计的形状。通过不断地更新和学习，最终得到人脸形状。原始级联回归模型如算法\ref{alg_cpr}所示。
\begin{algorithm}[h]
    \caption{级联姿态回归算法}\label{alg_cpr}
    %\SetAlgoNoLine
    \textbf{输入}：图像$I$，初始位置$S^0$，回归器$R^1,R^2,\cdots,R^T$，特征计算函数$h^t(S^t,I)$\\
    \textbf{输出}：估计的形状$S^T$\\
    \For {$k\gets1$ \KwTo $T$}{
        计算特征$x^t=h^t(S^{t-1},I)$ \\
        计算形状增量$\delta S=R^t(x^t)$ \\
        更新形状估计$S^t=S^{t-1}+R^t(I,S^{t-1})$ \\
    }
    \textbf{返回}：{$S^t$}
\end{algorithm}

通过利用全面的训练数据明确最小化对齐误差来训练回归器，即所有的面部标记联合回归。回归器以一种非参数化的方式理解形状的限制，回归的形状总是训练形状的一个线性组合，而且为所有标记使用全局特征比使用局部特征更有区分性。这些性能使我们能够学习到一个对于大量训练数据拥有较强表达能力的灵活的模型，这种方法被称为“显式形状回归”。对于整个形状采用联合回归的主要挑战在于图像外形的大幅变化。算法使用了一个增强的回归器来推断形状。即前期的回归器控制形状的大幅变化并且保证健壮，然后后期的回归器控制细小的形状变化并且保证准确度。这样形状约束自动的由粗到细的执行，如下图\ref{fig_esr}所示。
\begin{figure}[!ht] \centering
  \includegraphics[width=.7\textwidth]{figure/fig_esr.eps}
  \bicaption[显式形状回归示例]{显式形状回归示例 ~\label{fig_esr}}{Illustrations of explicit shape regression}
\end{figure}

学习一个好的弱分类器至关重要，并且能够减小误差。boosted regression与以前的方法相似，使用简单的弱回归器如决策树。然而这些回归器太弱导致在训练过程中收敛速度很慢，且在测试过程中效果不佳。当存在大的外观变化和粗略的初始化的时候，这些回归器将很难回归出整个的形状。在这种情况下，一个简单的回归器能降低误差但不具备很好的泛化能力。因此本文采用两层的级联分类器，如图\ref{fig_two_cascaded}所示，这样的二层级联方式能够克服收敛速度慢和泛化能力差的缺点。
\begin{figure}[ht] \centering
  \includegraphics[width=.7\textwidth]{figure/fig_two_cascaded.eps}
  \bicaption[两层级联回归模型]{两层的级联回归 ~\label{fig_two_cascaded}}{Two-level cascade regression model}
\end{figure}

算法采用两级形状回归方法计算形状回归量$R^t$。在第一级回归当中，主要用于产生特征，并更新形状。在第二级回归中，主要进行特征选择，并计算形状增量。二级回归是由若干个弱回归量$R^1,R^2,\cdots,R^T$组成，经过一级回归和二级回归的交叉迭代后产生一系列强回归量。一级回归中，采用形状特征索引方法获取特征，这种方式能准确定位特征位置，提取有效人脸特征。二级回归特征选择中，采用相关性特征选择方法，从特征池中选择与本次迭代相关性最大的几个特征作为本次迭代的人脸特征。这种方法能选择具有代表性的人脸特征，学习到较好的形状回归量。通过二级形状回归迭代后，输出对齐的人脸形状，该形状是由初始人脸形状和训练样本形状线性和表示，即：
\begin{equation}
\label{equ_esr_two_level}
S=S^0+\sum_{i=1}^{N}\omega_i\hat{S_i}
\end{equation}
其中，$\omega$为回归系数，$\hat{S_i}$为样本标准人脸形状。因为初始形状和样本形状都服从形状约束，所以输出的人脸形状也服从形状约束，这种线性表示方式能较好控制人脸形状。

为了解决复杂条件下人脸对齐的效率和准确率等问题，将人脸形状空间融合到级联回归框架中产生二级形状参数回归人脸对齐算法，以形状空间控制人脸形状，以低维形状参数进行形状迭代，较好解决对齐效率和对齐准确度问题。为使算法更高效，在二级形状参数回归中，给出结合旋转和尺度因素的明确形状特征索引方法和一种多重随机特征选择方法，能更准确定位和提取人脸特征，提高对齐精度。总体框架如图
\ref{fig_esr_framework}所示。
\begin{figure}[h] \centering
  \includegraphics[width=.8\textwidth]{figure/fig_esr_framework.eps}
  \bicaption[形状参数回归算法框架图]{形状参数回归算法框架图 ~\label{fig_esr_framework}}{Framework of shape parameter regression algorithm}
\end{figure}

由图\ref{fig_esr_framework}可看出，在学习阶段，使用人脸形状空间将标准形状和初始形状转换为低维的人脸形状参数，然后通过二级形状参数回归进行迭代更新，最后输出对齐的人脸形状，并生成一系列形状参数回归量$(R^1,R^2,\cdots,R^T)$。在测试阶段，将初始人脸形状转换成人脸参数，根据学习好的参数回归量$(R^1,R^2,\cdots,R^T)$进行二级形状参数回归，不断迭代更新人脸形状，最终输出对齐的人脸形状。

\subsection{形状索引特征}
要实现快速和精确的特征点检测，离不开有效并可快速计算的特征。之前的一些解决人脸角度和表情变化的算法，例如：PEP\supercite{Li2013Probabilistic}，DPM\supercite{Felzenszwalb2010Object}等，一般由于计算量太大，限制了它们的应用范围。因此，在这章中，我们将介绍本文的重点之一：形状索引特征(Shape Index Feature)。这个特征有如下两个优点：

1、形状索引特征的其中一个优势就是对齐的精度很高。这个特征对于人脸角度和表情的变化具有不变性。

2、形状索引特征的另一个优势就是提取速度极快。这个特征提取过程简单，可以用在快速的人脸检测和特征点定位的有关算法中。形状索引特征配合像素灰度值特征使用，可以获得十分迅速的提取速度。我们甚至都不需要得到相似变换后的人脸图像就可以直接得到形状索引像素特征。

本文从以下两个方面对形状索引特征进行详细介绍：

（1）消除全局变换

为了消除图片中的因为人脸在图片中的大小、位置和左右歪头而产生的影响。这里我们采用的方法是使用相似变换(similarity transformation)将人脸的$p$个基准点的位置映射到固定的位置上。这里我们只用其中5个基准点说明。相似变换的具体做法如下：

首先，我们假设图片中左右瞳孔、鼻尖、以及左右嘴角这五个基准点的位置分别为$(x_1,y_1,\cdots,x_5,y_5)$，我们将这些坐标排列成如下形式:
\begin{equation}
\label{equ_shape_index}
P=\begin{pmatrix}
x_1 & \cdots & x_5\\
y_1 & \cdots & y_5\\
1   & \cdots & 1
\end{pmatrix}
\end{equation}

假设我们需要将这5个映射到的固定的位置分别为$\bar{x_1},\bar{y_1},\cdots,\bar{x_5},\bar{y_5}$。这里需要注意的是，这些固定点的位置不可随意选取，如果选择不合适，会造成变换时的误差比较大，有时无法把人脸旋转到我们希望的正脸的效果。在我们的实验中，一般选择数据库上统计出来的这5个点的坐标的平均值。同样，我们将这5个固定位置也排列成如下形式:
\begin{equation}
\label{equ_shape_index2}
\bar{P}=\begin{pmatrix}
\bar{x_1} & \cdots & \bar{x_5}\\
\bar{y_1} & \cdots & \bar{y_5}\\
1         & \cdots &       1
\end{pmatrix}
\end{equation}
接着，我们需要估计一个相似变换矩阵$T$，这个变化将$P$映射到$\bar{P}$，即$\bar{P}=TP$。因为$T$是相似变换矩阵，所以$T$应该满足如下形式:
\begin{equation}
\label{equ_shape_index3}
T=\begin{pmatrix}
a   & b & \delta x\\
-b  & a & \delta y\\
0   & 0 &  1
\end{pmatrix}
\end{equation}
这里我们使用相似变换，而不是仿射变换，或者投影变换等是因为我们不希望扭曲人脸。因此我们希望变换中只包含旋转，平移和尺度变化。下面我们需要根据$P$和$\bar{P}$去估计$T$中的4个参数
$(a,b,\delta x,\delta y)$。这里我们使用最小二乘去估计，因为$\bar{P}=TP$，重新排列其中的元素的位置，可以得到如下表达式：
\begin{equation}
\bar{Q}=\Theta Q
\end{equation}
其中：
\begin{equation}
\Theta = (a,b,\delta x,\delta y)
\end{equation}
\begin{equation}
\bar{Q} = \bar{x_1},\bar{y_1},\cdots,\bar{x_5},\bar{y_5}
\end{equation}
\begin{equation}
Q=
\begin{pmatrix}
x_1 & y_1  & \cdots & x_5 &  y_5 \\
y_1 & -x_1 & \cdots & y_5 & -x_5 \\
1   & 0    & \cdots &  1  &  0   \\
0   & 1    & \cdots &  0  &  1
\end{pmatrix}
\end{equation}
这样可以利用最小二乘得到相似变换参数$\Theta=\bar{Q}Q^T(QQ^T)^{-1}$。知道了相似变换矩阵$T$之后，我们就可以生成相似变换后的正脸图像。在实际操作中，一般用逆向变换的方式去产生相似变换后的图像。即：对于相似变换后的图像中的每个位置$\bar{x},\bar{y}$，我们去寻找它在原图中的坐标(x,y)，其满足：
\begin{equation}
\begin{pmatrix}
x\\
y\\
1
\end{pmatrix}=T^{-1}\begin{pmatrix}
\bar{x}\\
\bar{y}\\
1
\end{pmatrix}
\end{equation}
相似变换之后的人脸图像和人脸基准点的结果如图所示，可以看到，这个图像已经消除了原图像中因为左右歪头而产生的影响，得到了一个正面的人脸图像，并且所有的基准点都在正确的位置上。在人脸特征点检测的过程当中，通过每一个回归器得到预估计的人脸形状，然后通过逆向变换的方式得到该形状变换到原始图像的形状，在达到一定的错误率的阈值后即收敛，从而得到预测的人脸特征点。因为人脸具有一定的几何结构，各个面部器官的相对位置基本保持不变，因此，相似变换之后的基准点一般会排列成一个相对固定的形状，我们称这种在经过相似变换之后的基准点周围提取的特征叫做形状索引特征(Shape Index Feature)。

（2）建立局部坐标系

得到相似变换之后的人脸图像和基准点之后，就可以以相似变换后的各个基准点为中心，建立局部坐标系来提取特征。对于基于区域统计的特征，例如LBP\supercite{Ojala2002Gray,Zhenhua2010A}、SIFT\supercite{Lowe2004Distinctive}、LE\supercite{Li2013Probabilistic}等，以各个基准点为中心，在其周围先截取一个矩形区域。然后再将这个矩形区域均匀的划分成多个小的矩形区域。接着在每个小的矩形区域里提取这些特征。最后将所有小矩形区域里的特征拼接起来即可。对于像素灰度值特征，取两个像素点的灰度差异作为特征。
\begin{figure}[!ht] \centering
  \includegraphics[width=.7\textwidth]{figure/fig_cordidate.eps}
  \bicaption[局部坐标系VS全局坐标系]{(a).~局部坐标系的像素索引具有相同的语义~(b).~全局坐标系下同位置的像素具有不同语义 ~\label{fig_cordidate}}[local coordinates Vs. Global coordinates]{(a).~Pixels indexed by the same local coordinates have the same semantic meaning~(b).~pixels indexed by the same global coordinates have different semantic meanings due to the face shape variation}
\end{figure}

以各个基准点为原点，以水平方向为$x$轴，竖直方向为$y$轴建立局部坐标系，每个像素提取点都是相对于其中某个局部的坐标系而言的。在实际中，一般用两个像素点的差作为特征，以获得更好的光照不变性。我们称这种以各个基准点为原点提取特征的方式叫局部坐标系特征，它是相对于以图像左上角为原点提取特征的这种全局坐标系特征而言的。这特征计算量极低，并且足够用来提供训练数据。全局坐标系不能适用于非刚性的人脸形状，因大部分有用的特征都是分布在突出的部位四周，比方说眼睛、鼻子和嘴巴，而且标记点的位置在人脸不同表情、不同姿态的时候变化很大。而使用局部坐标索引像素，以最近的标记点作为参考。这样索引可以保持不变性，特征拥有很强的鲁棒性。

如图\ref{fig_cordidate} (a)所示，以左眼右侧和嘴巴左侧的特征点为原点，建立局部坐标系，在给定两个不同偏移量大小的两个点所表示的含义是一样的，都为眉毛和嘴角。而\ref{fig_cordidate} (b)所示的在全局坐标系下，同样位置的两个点却表示人脸的不同位置。因此局部坐标系能够使得特征对齐，更加鲁棒，可以有效解决因旋转和尺度变换带来的干扰。
\subsection{自适应初始化}
为了解决简单模型中速度过慢的问题，提出了级联回归模型。这个模型基于以下观察：在以往的人脸检测算法中，例如在Viola \& Jones的人脸检测算法中，为了提高算法的速度，一般采用的是级联结构(Cascade Structure)，这种结构的特点是将人脸检测器分成多个阶段，每个阶段都拒绝掉一定量的负样本。因为图片中的绝大多数背景区域都会在很早期的时候就被拒掉，因此可以加速人脸检测算法。而在目前的人脸校准算法中，例如：ESR\supercite{Cao2012Face}、 SDM\supercite{Xiong2013Supervised}、LBF\supercite{Ren2014Face}等，这几种算法一般也分为多个阶段，在初始阶段一般解决的是大范围的变化，例如人脸角度的变化等。而在后面的阶段一般解决的是更加精细的变化，例如不同人的各个基准点的位置的微小差异等。

为了提高人脸特征点定位的准确度，级联回归模型一般采用多个初始化形状独立的运行多次，然后取最优的结果作为最终结果，这显然对速度有明显的影响。针对上述问题，本文提出一种自适应初始化策略。

上文提到，级联回归模型是一个由粗略到精细不断调整优化的过程，即使采用不同的初始化位置，在一定次数的迭代后都能达到相近的预测。如果不能达到相同或近似的值，那么很明显，初始化位置差异太大，也说明回归失败。为此我们的策略如下：给定一张图片以及一组不同的初始化值，最初只执行10\% 的级联次数；然后检测预测值的变化，如果变化小于给定的阈值，那么剩下90\% 的级联能够继续执行；否则，就选择一个新的初始值重新开始 。后续实验证明，在保证正确率的前提下，本方法对人脸特征点定位的速度有很大提升。
%\subsection{算法复杂度分析}
\section{本章小结}
本章主要介绍了人脸特征点定位的相关工作。人脸特征点是人脸识别的重要的预处理部分，也是人脸对齐、特征提取等基础的工作。如何针对真实监控场景下的人脸形变问题而快速的得到精确的人脸特征点对后续的工作有非常大的作用。首先，介绍了经典的AAM框架，AAM作为一种经典的框架，一般作为基准算法进行对比。本章介绍此节目的也是为了跟本文提出的方法进行对比。其次，本章介绍了级联回归模型，本文所提出人脸特征点定位方法在经典的级联回归模型上进一步改进，通过采用局部坐标系下的形状索引特征、两级级联回归和自适应的初始化方法，实现了一种快速而又精确的人脸特征点定位方法，为后续的人脸识别工作提供了保障。
